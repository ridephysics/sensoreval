\documentclass[titlepage]{article}
\usepackage{amsmath}
\usepackage{tikz}
\usetikzlibrary{angles,quotes}
\numberwithin{equation}{section}

\begin{document}

\title{Equations of Motion: Booster}
\author{Michael Zimmermann}
\date{}
\maketitle

\section{Diagram}
\begin{tikzpicture}
% coordinate system
\draw[thick,->] (-5,0) -- (5,0) node[anchor=north west] {x};
\draw[thick,->] (0,-5) -- (0,5) node[anchor=south east] {y};
\draw[fill=black] (0,0) circle (0.1cm) node[label={[above,label distance=0.5cm]east:{$(0, 0)$}}]{};

% rods
\draw (0,0) -- (4,-2) node[pos=0.5,fill=white]{r};
\draw (4,-2) -- (6,-4) node[above,pos=0.5]{l1};
\draw[fill=black] (4,-2) circle (0.1cm);

\draw (0,0) -- (-4,2) node[pos=0.5,fill=white]{r};
\draw (-4,2) -- (-6,4) node[below,pos=0.5]{l2};
\draw[fill=black] (-4,2) circle (0.1cm);

% angles
\draw
  (4,-3) coordinate (a)
  (4,-2) coordinate (b)
  (6,-4) coordinate (c)
  pic["$\theta_1$", draw=black, ->, angle radius=1.5cm]{angle=a--b--c};
  
\draw
  (-4,1) coordinate (a)
  (-4,2) coordinate (b)
  (-6,4) coordinate (c)
  pic["$\theta_2$", draw=black, ->, angle radius=1.5cm]{angle=a--b--c};

\draw
  (0,-4) coordinate (a)
  (0,0) coordinate (b)
  (4,-2) coordinate (c)
  pic["$\theta_3$", draw=black, ->, angle radius=1.5cm]{angle=a--b--c};

% masses
\draw[fill=white] (6,-4) circle (0.5cm) node[label={[label distance=0.2cm]east:{$(x_1, y_1)$}}]{m1};
\draw[fill=white] (-6,4) circle (0.5cm) node[label={[label distance=0.2cm]west:{$(x_2, y_2)$}}]{m2};

\end{tikzpicture}

\section{Assumptions}
\begin{itemize}
	\item Point masses
	\item Infinitely thin rigid rod with length and mass, rotating about it's center
	\item Massless, rigid outer rods
	\item Gravity is present
\end{itemize}

\section{Trigonometric Identities}
\begin{equation} \label{eq:ti1}
\cos a \cos b + \sin a \sin b = \cos{a - b}
\end{equation}

\pagebreak
\section{Kinematic Constrains}
\begin{equation} \label{eq:x_1}
x_1 = r \sin \theta_3 + l_1 \sin \theta_1
\end{equation}
\begin{equation} \label{eq:y_1}
y_1 = -r \cos \theta_3 - l_1 \cos \theta_1
\end{equation}

\begin{equation} \label{eq:x_2}
x_2 = -r \sin \theta_3 + l_2 \sin \theta_2
\end{equation}
\begin{equation} \label{eq:y_2}
y_2 = r \cos \theta_3 - l_2 \cos \theta_2
\end{equation}

\section{Velocities}
\begin{equation} \label{eq:x_1_dot}
\dot{x_1} = r \cos \theta_3 \dot{\theta_3} + l_1 \cos \theta_1 \dot{\theta_1}
\end{equation}
\begin{equation} \label{eq:y_1_dot}
\dot{y_1} = r \sin \theta_3 \dot{\theta_3} + l_1 \sin \theta_1 \dot{\theta_1}
\end{equation}

\begin{equation} \label{eq:x_2_dot}
\dot{x_2} = -r \cos \theta_3 \dot{\theta_3} + l_2 \cos \theta_2 \dot{\theta_2}
\end{equation}
\begin{equation} \label{eq:y_2_dot}
\dot{y_2} = -r \sin \theta_3 \dot{\theta_3} + l_2 \sin \theta_2 \dot{\theta_2}
\end{equation}

\section{Potential Energy}
\begin{equation} \label{eq:V_base}
V = m_1 g y_1 + m_2 g y_2
\end{equation}
Substitute \ref{eq:y_1}, \ref{eq:y_2} into \ref{eq:V_base}:
\begin{equation} \label{eq:V}
V = m_1 g (-r \cos \theta_3 - l_1 \cos \theta_1) + m_2 g (r \cos \theta_3 - l_2 \cos \theta_2)
\end{equation}

\section{Kinetic Energy}
Moment of inertia of the inner rod:
\begin{equation} \label{eq:I}
I = \frac{1}{12} m L^2 = \frac{1}{12} m_3 (2 r)^2
\end{equation}
Base formula:
\begin{equation}
T = \frac{1}{2} m_1 v_1^2 + \frac{1}{2} m_2 v_2^2 + \frac{1}{2} I \dot{\theta_3}^2
\end{equation}
Pythagoras:
\begin{equation} \label{eq:T_pre_subs_I}
T = \frac{1}{2} m_1 (\dot{x_1}^2 + \dot{y_1}^2) + \frac{1}{2} m_2 (\dot{x_2}^2 + \dot{y_2}^2) + \frac{1}{2} I \dot{\theta_3}^2
\end{equation}
Substitute \ref{eq:I} into \ref{eq:T_pre_subs_I}:
\begin{align}
T &= \frac{1}{2} m_1 (\dot{x_1}^2 + \dot{y_1}^2) + \frac{1}{2} m_2 (\dot{x_2}^2 + \dot{y_2}^2) + \frac{1}{2} \frac{1}{12} m_3 (2 r)^2 \dot{\theta_3}^2 \nonumber \\
&= \frac{1}{2} m_1 (\dot{x_1}^2 + \dot{y_1}^2) + \frac{1}{2} m_2 (\dot{x_2}^2 + \dot{y_2}^2) + \frac{1}{6} m_3 r^2 \dot{\theta_3}^2 \label{eq:T_base}
\end{align}
Substitute \ref{eq:x_1_dot}, \ref{eq:y_1_dot}, \ref{eq:x_2_dot}, \ref{eq:y_2_dot} into \ref{eq:T_base}:
\begin{align}
T &= \frac{1}{2} m_1 ((r \cos \theta_3 \dot{\theta_3} + l_1 \cos \theta_1 \dot{\theta_1})^2 + (r \sin \theta_3 \dot{\theta_3} + l_1 \sin \theta_1 \dot{\theta_1})^2) \nonumber \\
  &+ \frac{1}{2} m_2 ((-r \cos \theta_3 \dot{\theta_3} + l_2 \cos \theta_2 \dot{\theta_2})^2 + (-r \sin \theta_3 \dot{\theta_3} + l_2 \sin \theta_2 \dot{\theta_2})^2) \nonumber \\
  &+ \frac{1}{6} m_3 r^2 \dot{\theta_3}^2
\end{align}
expand the squares using Pythagoras:
\begin{align}
T &= \frac{1}{2} m_1 (r^2 \cos^2 \theta_3 \dot{\theta_3}^2 + 2 r \cos \theta_3 \dot{\theta_3} l_1 \cos \theta_1 \dot{\theta_1} + l_1^2 \cos^2 \theta_1 \dot{\theta_1}^2 \nonumber \\
  &+ r^2 \sin^2 \theta_3 \dot{\theta_3}^2 + 2 r \sin \theta_3 \dot{\theta_3} l_1 \sin \theta_1 \dot{\theta_1} + l_1^2 \sin^2 \theta_1 \dot{\theta_1}^2) \nonumber \\
  &+ \frac{1}{2} m_2 (r^2 \cos^2 \theta_3 \dot{\theta_3}^2 - 2 r \cos \theta_3 \dot{\theta_3} l_2 \cos \theta_2 \dot{\theta_2} + l_2^2 \cos^2 \theta_2 \dot{\theta_2}^2 \nonumber \\
  &+ r^2 \sin^2 \theta_3 \dot{\theta_3}^2 - 2 r \sin \theta_3 \dot{\theta_3} l_2 \sin \theta_2 \dot{\theta_2} + l_2^2 \sin^2 \theta_2 \dot{\theta_2}^2) \nonumber \\
  &+ \frac{1}{6} m_3 r^2 \dot{\theta_3}^2
\end{align}
Simplify using \ref{eq:ti1}:
\begin{align}
T &= \frac{1}{2} m_1 (r^2 \dot{\theta_3}^2 + 2 r \dot{\theta_3} l_1 \dot{\theta_1} \cos{(\theta_3 - \theta_1)} + l_1^2 \dot{\theta_1}^2) \nonumber \\
 & + \frac{1}{2} m_2 (r^2 \dot{\theta_3}^2 - 2 r \dot{\theta_3} l_2 \dot{\theta_2} \cos{(\theta_3 - \theta_2)} + l_2^2 \dot{\theta_2}^2) \nonumber \\
 &+ \frac{1}{6} m_3 r^2 \dot{\theta_3}^2
\end{align}
Expand:
\begin{align}
T &= \frac{1}{2} m_1 r^2 \dot{\theta_3}^2 + m_1 r \dot{\theta_3} l_1 \dot{\theta_1} \cos{(\theta_3 - \theta_1)} + \frac{1}{2} m_1 l_1^2 \dot{\theta_1}^2 \nonumber \\
 & + \frac{1}{2} m_2 r^2 \dot{\theta_3}^2 - m_2 r \dot{\theta_3} l_2 \dot{\theta_2} \cos{(\theta_3 - \theta_2)} + \frac{1}{2} m_2 l_2^2 \dot{\theta_2}^2 \nonumber \\
 &+ \frac{1}{6} m_3 r^2 \dot{\theta_3}^2 \label{eq:T}
\end{align}

\section{Lagrangian}
\begin{equation} \label{eq:L_base}
L = T - V
\end{equation}
Substitute \ref{eq:T}, \ref{eq:V} into \ref{eq:L_base}:
\begin{align}
L &= \frac{1}{2} m_1 r^2 \dot{\theta_3}^2 + m_1 r \dot{\theta_3} l_1 \dot{\theta_1} \cos{(\theta_3 - \theta_1)} + \frac{1}{2} m_1 l_1^2 \dot{\theta_1}^2 \nonumber \\
 & + \frac{1}{2} m_2 r^2 \dot{\theta_3}^2 - m_2 r \dot{\theta_3} l_2 \dot{\theta_2} \cos{(\theta_3 - \theta_2)} + \frac{1}{2} m_2 l_2^2 \dot{\theta_2}^2 \nonumber \\
 &+ \frac{1}{6} m_3 r^2 \dot{\theta_3}^2 \nonumber \\
 &- m_1 g (-r \cos \theta_3 - l_1 \cos \theta_1) - m_2 g (r \cos \theta_3 - l_2 \cos \theta_2)
\end{align}

\section{Lagrange's Equations}
\begin{equation} \label{eq:LE_base}
\frac{d}{dt} \left(\frac{\partial L}{\partial \dot{q}_j}\right) - \frac{\partial L}{\partial q_j}
\end{equation}

\pagebreak
\subsection{$\theta_1$}
\begin{align}
\frac{\partial L}{\partial \dot{\theta_1}} &= m_1 r \dot{\theta_3} l_1 \cos{(\theta_3 - \theta_1)} + m_1 l_1^2 \dot{\theta_1}
\end{align}

\begin{align}
\frac{d}{dt} \left(\frac{\partial L}{\partial \dot{\theta_1}}\right) &= m_1 r \ddot{\theta_3} l_1 \cos{(\theta_3 - \theta_1)} \nonumber \\
 &- m_1 r \dot{\theta_3} l_1 \sin{(\theta_3 - \theta_1)} (\dot{\theta_3} - \dot{\theta_1}) \nonumber \\
 &+ m_1 l_1^2 \ddot{\theta_1} \label{eq:LE_left_t1}
\end{align}

\begin{align}
\frac{\partial L}{\partial \theta_1} &= m_1 r \dot{\theta_3} l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} - m_1 g l_1 \sin \theta_1 \label{eq:LE_right_t1}
\end{align}

\bigskip
\noindent
Substitute \ref{eq:LE_left_t1}, \ref{eq:LE_right_t1} into \ref{eq:LE_base}:
\begin{align}
 &+ m_1 r \ddot{\theta_3} l_1 \cos{(\theta_3 - \theta_1)} \nonumber \\
 &- m_1 r \dot{\theta_3} l_1 \sin{(\theta_3 - \theta_1)} (\dot{\theta_3} - \dot{\theta_1}) \nonumber \\
 &+ m_1 l_1^2 \ddot{\theta_1} \nonumber \\
 &- m_1 r \dot{\theta_3} l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} \nonumber \\
 &+ m_1 g l_1 \sin \theta_1 \nonumber \\
 &= 0
\end{align}
Simplify:
\begin{align}
 &+ m_1 r \ddot{\theta_3} l_1 \cos{(\theta_3 - \theta_1)} \nonumber \\
 &- m_1 r \dot{\theta_3}^2 l_1 \sin{(\theta_3 - \theta_1)} \nonumber \\
 &+ m_1 l_1^2 \ddot{\theta_1} \nonumber \\
 &+ m_1 g l_1 \sin \theta_1 \nonumber \\
 &= 0
\end{align}
Cancel out $l_1 m_1$:
\begin{align}
 &+ r \ddot{\theta_3} \cos{(\theta_3 - \theta_1)} \nonumber \\
 &- r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_1)} \nonumber \\
 &+ l_1 \ddot{\theta_1} \nonumber \\
 &+ g \sin \theta_1 \nonumber \\
 &= 0
\end{align}
Rearrange:
\begin{equation}
 r \ddot{\theta_3} \cos{(\theta_3 - \theta_1)} - r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_1)} + l_1 \ddot{\theta_1} + g \sin \theta_1 = 0
\end{equation}

\subsection{$\theta_2$}
\begin{equation}
\frac{\partial L}{\partial \dot{\theta_2}} = - m_2 r \dot{\theta_3} l_2 \cos{(\theta_3 - \theta_2)} + m_2 l_2^2 \dot{\theta_2}
\end{equation}

\begin{align}
\frac{d}{dt} \left(\frac{\partial L}{\partial \dot{\theta_2}}\right) = &- m_2 r \ddot{\theta_3} l_2 \cos{(\theta_3 - \theta_2)} \nonumber \\
 &+ m_2 r \dot{\theta_3} l_2 \sin{(\theta_3 - \theta_2)} (\dot{\theta_3} - \dot{\theta_2}) \nonumber \\
 &+ m_2 l_2^2 \ddot{\theta_2} \label{eq:LE_left_t2}
\end{align}

\begin{align}
\frac{\partial L}{\partial \theta_2} = &- m_2 r \dot{\theta_3} l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} \nonumber \\
 &- m_2 g l_2 \sin \theta_2 \label{eq:LE_right_t2}
\end{align}

\bigskip
\noindent
Substitute \ref{eq:LE_left_t2}, \ref{eq:LE_right_t2} into \ref{eq:LE_base}:
\begin{align}
 &- m_2 r \ddot{\theta_3} l_2 \cos{(\theta_3 - \theta_2)} \nonumber \\
 &+ m_2 r \dot{\theta_3} l_2 \sin{(\theta_3 - \theta_2)} (\dot{\theta_3} - \dot{\theta_2}) \nonumber \\
 &+ m_2 l_2^2 \ddot{\theta_2} \nonumber \\
 &+ m_2 r \dot{\theta_3} l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} \nonumber \\
 &+ m_2 g l_2 \sin \theta_2 \nonumber \\
 &= 0
\end{align}
Simplify:
\begin{align}
 &- m_2 r \ddot{\theta_3} l_2 \cos{(\theta_3 - \theta_2)} \nonumber \\
 &+ m_2 r \dot{\theta_3}^2 l_2 \sin{(\theta_3 - \theta_2)} \nonumber \\
 &+ m_2 l_2^2 \ddot{\theta_2} \nonumber \\
 &+ m_2 g l_2 \sin \theta_2 \nonumber \\
 &= 0
\end{align}
Cancel out $l_2 m_2$:
\begin{align}
 &- r \ddot{\theta_3} \cos{(\theta_3 - \theta_2)} \nonumber \\
 &+ r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_2)} \nonumber \\
 &+ l_2 \ddot{\theta_2} \nonumber \\
 &+ g \sin \theta_2 \nonumber \\
 &= 0
\end{align}
Rearrange:
\begin{equation}
 - r \ddot{\theta_3} \cos{(\theta_3 - \theta_2)} + r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_2)} + l_2 \ddot{\theta_2} + g \sin \theta_2 = 0
\end{equation}

\subsection{$\theta_3$}
\begin{align}
\frac{\partial L}{\partial \dot{\theta_3}} &= m_1 r^2 \dot{\theta_3} + m_1 r l_1 \dot{\theta_1} \cos{(\theta_3 - \theta_1)} \nonumber \\
 &+ m_2 r^2 \dot{\theta_3} - m_2 r l_2 \dot{\theta_2} \cos{(\theta_3 - \theta_2)} \nonumber \\
 &+ \frac{1}{3} m_3 r^2 \dot{\theta_3}
\end{align}

\begin{align}
\frac{d}{dt} \left(\frac{\partial L}{\partial \dot{\theta_3}}\right) &= m_1 r^2 \ddot{\theta_3} \nonumber \\
 &+ m_1 r l_1 \ddot{\theta_1} \cos{(\theta_3 - \theta_1)} - m_1 r l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} (\dot{\theta_3} - \dot{\theta_1}) \nonumber \\
 &+ m_2 r^2 \ddot{\theta_3} \nonumber \\
 &- m_2 r l_2 \ddot{\theta_2} \cos{(\theta_3 - \theta_2)} + m_2 r l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} (\dot{\theta_3} - \dot{\theta_2}) \nonumber \\
 &+ \frac{1}{3} m_3 r^2 \ddot{\theta_3} \label{eq:LE_left_t3}
\end{align}

\begin{align}
\frac{\partial L}{\partial \theta_3} = &- m_1 r \dot{\theta_3} l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} \nonumber \\
 &+ m_2 r \dot{\theta_3} l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} \nonumber \\
 &- m_1 g r \sin \theta_3 \nonumber \\
 &+ m_2 g r \sin \theta_3
\label{eq:LE_right_t3}
\end{align}

Substitute \ref{eq:LE_left_t3}, \ref{eq:LE_right_t3} into \ref{eq:LE_base}:
\begin{align}
 &+ m_1 r^2 \ddot{\theta_3} \nonumber \\
 &+ m_1 r l_1 \ddot{\theta_1} \cos{(\theta_3 - \theta_1)} - m_1 r l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} (\dot{\theta_3} - \dot{\theta_1}) \nonumber \\
 &+ m_2 r^2 \ddot{\theta_3} \nonumber \\
 &- m_2 r l_2 \ddot{\theta_2} \cos{(\theta_3 - \theta_2)} + m_2 r l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} (\dot{\theta_3} - \dot{\theta_2}) \nonumber \\
 &+ \frac{1}{3} m_3 r^2 \ddot{\theta_3} \nonumber \\
 &+ m_1 r \dot{\theta_3} l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} \nonumber \\
 &- m_2 r \dot{\theta_3} l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} \nonumber \\
 &+ m_1 g r \sin \theta_3 \nonumber \\
 &- m_2 g r \sin \theta_3 \nonumber \\
 &= 0
\end{align}
Combine similar terms:
\begin{align}
 &+ m_1 r l_1 \ddot{\theta_1} \cos{(\theta_3 - \theta_1)} - m_1 r l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} (\dot{\theta_3} - \dot{\theta_1}) \nonumber \\
 &- m_2 r l_2 \ddot{\theta_2} \cos{(\theta_3 - \theta_2)} + m_2 r l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} (\dot{\theta_3} - \dot{\theta_2}) \nonumber \\
 &+ (m_1 + m_2 + \frac{1}{3} m_3) r^2 \ddot{\theta_3} \nonumber \\
 &+ m_1 r \dot{\theta_3} l_1 \dot{\theta_1} \sin{(\theta_3 - \theta_1)} \nonumber \\
 &- m_2 r \dot{\theta_3} l_2 \dot{\theta_2} \sin{(\theta_3 - \theta_2)} \nonumber \\
 &+ (m_1 - m2) g r \sin \theta_3 \nonumber \\
 &= 0
\end{align}
Simplify:
\begin{align}
 &+ m_1 r l_1 \ddot{\theta_1} \cos{(\theta_3 - \theta_1)} + m_1 r l_1 \dot{\theta_1}^2 \sin{(\theta_3 - \theta_1)} \nonumber \\
 &- m_2 r l_2 \ddot{\theta_2} \cos{(\theta_3 - \theta_2)} - m_2 r l_2 \dot{\theta_2}^2 \sin{(\theta_3 - \theta_2)} \nonumber \\
 &+ (m_1 + m_2 + \frac{1}{3} m_3) r^2 \ddot{\theta_3} + (m_1 - m2) g r \sin \theta_3 \nonumber \\
 &= 0
\end{align}
Cancel out $r$
\begin{align}
 &+ m_1 l_1 \ddot{\theta_1} \cos{(\theta_3 - \theta_1)} + m_1 l_1 \dot{\theta_1}^2 \sin{(\theta_3 - \theta_1)} \nonumber \\
 &- m_2 l_2 \ddot{\theta_2} \cos{(\theta_3 - \theta_2)} - m_2 l_2 \dot{\theta_2}^2 \sin{(\theta_3 - \theta_2)} \nonumber \\
 &+ (m_1 + m_2 + \frac{1}{3} m_3) r \ddot{\theta_3} + (m_1 - m2) g \sin \theta_3 \nonumber \\
 &= 0
\end{align}

\pagebreak
\section{State space}
Matrix $M$, $x$ is the row, $y$ the column:
\begin{equation}
M_{xy}
\end{equation}
vector of all angles:
\begin{equation}
\overrightarrow{\theta} = \left\{\!
\begin{array}{c}
  \theta_1 \\
  \theta_2 \\
  \theta_3
\end{array}
\!\right\}
\end{equation}
vector of all functions:
\begin{equation}
\overrightarrow{F} = \left\{\!
\begin{array}{c}
  f_1 \\
  f_2 \\
  f_3
\end{array}
\!\right\}
\end{equation}
Acceleration:
\begin{align}
\overrightarrow{F} = \ddot{\overrightarrow{\theta}} \cdot M \\
\ddot{\overrightarrow{\theta}} = M^{-1} \cdot \overrightarrow{F}
\end{align}
Final state space:
\begin{equation}
\dot{\overrightarrow{y}} = \frac{d}{dt}
\left\{\!
\begin{array}{c}
  \overrightarrow{\theta} \\
  \dot{\overrightarrow{\theta}}
\end{array}
\!\right\} = 
\left\{\!
\begin{array}{c}
  \dot{\overrightarrow{\theta}} \\
  M^{-1} \cdot \overrightarrow{F}
\end{array}
\!\right\}
\end{equation}

\pagebreak
\subsection{$\theta_1$}
move accelerations to the left:
\begin{align}
l_1 \ddot{\theta_1} + r \ddot{\theta_3} \cos{(\theta_3 - \theta_1)} = r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_1)} - g \sin \theta_1
\end{align}
Matrix row:
\begin{equation}
M_1 = \begin{bmatrix}
      l_1 & 0 & r \cos{(\theta_3 - \theta_1)}
      \end{bmatrix}
\end{equation}
Function:
\begin{equation}
f_1 = r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_1)} - g \sin \theta_1
\end{equation}

\subsection{$\theta_2$}
move accelerations to the left:
\begin{align}
l_2 \ddot{\theta_2} - r \ddot{\theta_3} \cos{(\theta_3 - \theta_2)} = - r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_2)} - g \sin \theta_2
\end{align}
Matrix row:
\begin{equation}
M_2 = \begin{bmatrix}
      0 & l_2 & - r \cos{(\theta_3 - \theta_2)}
      \end{bmatrix}
\end{equation}
Function:
\begin{equation}
f_2 = - r \dot{\theta_3}^2 \sin{(\theta_3 - \theta_2)} - g \sin \theta_2
\end{equation}

\subsection{$\theta_3$}
move accelerations to the left:
\begin{align}
 &+ m_1 l_1 \ddot{\theta_1} \cos{(\theta_3 - \theta_1)} - m_2 l_2 \ddot{\theta_2} \cos{(\theta_3 - \theta_2)} + (m_1 + m_2 + \frac{1}{3} m_3) r \ddot{\theta_3} \nonumber \\
 &= - m_1 l_1 \dot{\theta_1}^2 \sin{(\theta_3 - \theta_1)} + m_2 l_2 \dot{\theta_2}^2 \sin{(\theta_3 - \theta_2)} - (m_1 - m2) g \sin \theta_3
\end{align}
Matrix row:
\begin{equation}
M_3 = \begin{bmatrix}
      m_1 l_1 \cos{(\theta_3 - \theta_1)} & - m_2 l_2 \cos{(\theta_3 - \theta_2)} & (m_1 + m_2 + \frac{1}{3} m_3) r
      \end{bmatrix}
\end{equation}
Function:
\begin{align}
f_3 = &- m_1 l_1 \dot{\theta_1}^2 \sin{(\theta_3 - \theta_1)} \nonumber \\
    &+ m_2 l_2 \dot{\theta_2}^2 \sin{(\theta_3 - \theta_2)} \nonumber \\
    &- (m_1 - m2) g \sin \theta_3
\end{align}

\end{document}